name: End-to-end Tests (cypress)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Avoid piling up runs for the same commit/PR
concurrency:
  group: e2e-${{ github.workflow }}-${{ github.event.pull_request.head.sha || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  try-big:
    name: Try big runner first
    uses: ./.github/workflows/reusable-cypress.yml
    with:
      runner: ubuntu-22.04-8vcpu-32gb-300gbssd
      timeout_minutes: 20
      browser: chrome
      command: yarn cy-parallel
    secrets: inherit

  check-claim:
    name: Wait & decide fallback
    runs-on: ubuntu-latest
    # Run in parallel with try-big so we don't block on capacity
    timeout-minutes: 10
    outputs:
      should_run_fallback: ${{ steps.decide.outputs.should_run_fallback }}
    steps:
      - name: Grace period before checking (tune as needed)
        run: sleep 300

      - name: Try to download claim
        id: dl
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: runner-claim
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.run_id }}
          path: ./claim
          repository: ${{ github.repository }}

      - name: Decide
        id: decide
        run: |
          if [ -f "./claim/claim.txt" ]; then
            echo "Big runner already started; no fallback."
            echo "should_run_fallback=false" >> "$GITHUB_OUTPUT"
          else
            echo "No claim found; run fallback."
            echo "should_run_fallback=true" >> "$GITHUB_OUTPUT"
          fi

  fallback:
    name: Fallback on ubuntu-latest
    needs: [check-claim]
    if: ${{ needs.check-claim.outputs.should_run_fallback == 'true' }}
    uses: ./.github/workflows/reusable-cypress.yml
    with:
      runner: ubuntu-latest
      timeout_minutes: 25
      browser: chrome
      command: yarn cy-parallel
    secrets: inherit
