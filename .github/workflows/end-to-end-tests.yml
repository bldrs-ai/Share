name: End-to-end Tests (cypress)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Avoid piling up runs for the same commit/PR
concurrency:
  group: e2e-${{ github.workflow }}-${{ github.event.pull_request.head.sha || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  cypress-run:
    name: Run cypress on dedicated runner
    uses: ./.github/workflows/reusable-cypress.yml
    with:
      runner: ubuntu-22.04-8vcpu-32gb-300gbssd
      timeout_minutes: 20
      browser: chrome
      command: yarn cy-parallel
    secrets: inherit

  cypress-watchdog:
    name: Watchdog checking cypress is running on dedicated runner
    runs-on: ubuntu-latest
    # Run in parallel with cypress-run so we don't block on capacity
    timeout-minutes: 10
    outputs:
      should_run_fallback: ${{ steps.decide.outputs.should_run_fallback }}
    steps:
      - name: Waiting until check
        run: sleep 300 # 5 minutes

      - name: Download cypress-run claim
        id: dl
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: runner-claim
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.run_id }}
          path: ./claim
          repository: ${{ github.repository }}

      - name: Decide
        id: decide
        run: |
          if [ -f "./claim/claim.txt" ]; then
            echo "Cypress is running fine."
            echo "should_run_fallback=false" >> "$GITHUB_OUTPUT"
          else
            echo "Cypress is stuck; running fallback."
            echo "should_run_fallback=true" >> "$GITHUB_OUTPUT"
          fi

  cypress-fallback:
    name: Fallback run of cypress on github shared runner
    needs: [cypress-watchdog]
    if: ${{ needs.cypress-watchdog.outputs.should_run_fallback == 'true' }}
    uses: ./.github/workflows/reusable-cypress.yml
    with:
      runner: ubuntu-latest
      timeout_minutes: 25
      browser: chrome
      command: yarn cy-parallel
    secrets: inherit
