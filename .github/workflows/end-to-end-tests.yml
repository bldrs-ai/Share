name: flows

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Avoid piling up runs for the same commit/PR
concurrency:
  group: e2e-${{ github.workflow }}-${{ github.event.pull_request.head.sha || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

jobs:
  cypress-dedicated:
    uses: ./.github/workflows/reusable-cypress.yml
    with:
      runner: ubuntu-22.04-8vcpu-32gb-300gbssd
      timeout_minutes: 20
      browser: chrome
      command: yarn cy
    secrets: inherit

  cypress-watchdog:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      should_run_fallback: ${{ steps.decide.outputs.should_run_fallback }}
    steps:
      - name: Polling for 2 minutes every 10s
        id: poll-cypress-started
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Polling for 'runner-claim' artifact on run ${{ github.run_id }}..."
          found="false"
          for i in {1..12}; do
            echo "Attempt $i..."
            # ðŸ‘‡ restrict to THIS workflow run
            if gh api \
              repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts \
              --jq 'any(.artifacts[]?; .name == "runner-claim")' | grep -q true; then
              echo "Found runner-claim artifact!"
              found="true"
              break
            fi
            sleep 10
          done
          echo "claim_found=$found" >> "$GITHUB_OUTPUT"

      - name: Decide
        id: decide
        run: |
          if [[ "${{ steps.poll-cypress-started.outputs.claim_found }}" == "true" ]]; then
            echo "Cypress is running on the big runner; skip fallback."
            echo "should_run_fallback=false" >> "$GITHUB_OUTPUT"
          else
            echo "No claim detected; run fallback."
            echo "should_run_fallback=true" >> "$GITHUB_OUTPUT"
          fi
  
  cypress-fallback:
    needs: [cypress-watchdog]
    if: ${{ needs.cypress-watchdog.outputs.should_run_fallback == 'true' }}
    uses: ./.github/workflows/reusable-cypress.yml
    with:
      runner: ubuntu-latest
      timeout_minutes: 25
      browser: chrome
      command: yarn cy
    secrets: inherit
