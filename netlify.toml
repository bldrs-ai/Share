# Configuration for integrating bolt.new into Share at /build path
# Note: This approach copies bolt.new's built files but may require additional
# configuration in bolt.new's vite.config.ts to set base: '/build/'

[build]
  command = """
    # Build Share first so its /index.js lives in the publish directory
    npm run build && \
    # Clone and build bolt.new (private repo - requires GITHUB_BOLT_TOKEN)
    git clone https://${GITHUB_BOLT_TOKEN}@github.com/bldrs-ai/bolt.new.git temp-bolt && \
    cd temp-bolt && \
    corepack enable && \
    NODE_ENV=development pnpm install && \
    pnpm run build && \
    cd .. && \
    # Place bolt.new client bundle under Share's build/build (served at /build/*)
    rm -rf build/build && \
    mkdir -p build/build && \
    cp -R temp-bolt/build/client/* build/build/ && \
    # Copy bolt.new server bundle into Netlify functions directory
    rm -rf netlify/functions/bolt && \
    mkdir -p netlify/functions/bolt && \
    cp -R temp-bolt/build/server/* netlify/functions/bolt/ && \
    rm -rf temp-bolt
    # Build Share
    yarn build
  """
  publish = "build"
  functions = "netlify/functions"

# bolt.new's Remix server runs from /.netlify/functions/bolt

[build.environment]
  NODE_VERSION = "20"
  # GITHUB_BOLT_TOKEN must be set in Netlify environment variables
  # Create a GitHub Personal Access Token with 'repo' scope at:
  # https://github.com/settings/tokens
  # Add it to Netlify: Site settings > Build & deploy > Environment > Environment variables (name it GITHUB_BOLT_TOKEN)

# Apply strict cross-origin isolation for all routes by default
[[headers]]
  for = "/*"
  [headers.values]
    Cross-Origin-Opener-Policy = "same-origin"
    Cross-Origin-Embedder-Policy = "require-corp"

# Headers for /build path (bolt.new app)
[[headers]]
  for = "/build/*"
  [headers.values]
    Cross-Origin-Opener-Policy = "same-origin"
    Cross-Origin-Embedder-Policy = "require-corp"
    Cross-Origin-Resource-Policy = "cross-origin"

# Asset caching for bolt.new assets
[[headers]]
  for = "/build/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Override headers for the /subscribe route so that no strict isolation is enforced.
[[headers]]
  for = "/subscribe/*"
  [headers.values]
    Cross-Origin-Opener-Policy = "unsafe-none"
    Cross-Origin-Embedder-Policy = "unsafe-none"

# Redirect /subscribe to /subscribe/ to enforce a trailing slash.
[[redirects]]
  from = "/subscribe"
  to = "/subscribe/"
  status = 301
  force = true

# Keep bolt.new static assets served from /build/assets without hitting the function
[[redirects]]
  from = "/build/assets/*"
  to = "/build/assets/:splat"
  status = 200

# Route everything else under /build to the bolt Remix server function
[[redirects]]
  from = "/build"
  to = "/.netlify/functions/bolt"
  status = 200

[[redirects]]
  from = "/build/*"
  to = "/.netlify/functions/bolt"
  status = 200
