# Configuration for integrating bolt.new into Share at /build path

[build]
  command = """
    # Clone and build bolt.new (private repo - requires GITHUB_BOLT_TOKEN)
    git clone https://${GITHUB_BOLT_TOKEN}@github.com/bldrs-ai/bolt.new.git temp-bolt && \
    cd temp-bolt && \
    corepack enable && \
    NODE_ENV=development pnpm install && \
    pnpm run build && \
    cd .. && \
    mkdir -p public/build && \
    cp -r temp-bolt/build/client/* public/build/ && \
    rm -rf temp-bolt && \
    # Build Share
    yarn build
  """
  publish = "public"

[build.environment]
  NODE_VERSION = "20"
  # GITHUB_BOLT_TOKEN must be set in Netlify environment variables
  # Create a GitHub Personal Access Token with 'repo' scope at:
  # https://github.com/settings/tokens
  # Add it to Netlify: Site settings > Build & deploy > Environment > Environment variables

# Apply strict cross-origin isolation for all routes by default
[[headers]]
  for = "/*"
  [headers.values]
    Cross-Origin-Opener-Policy = "same-origin"
    Cross-Origin-Embedder-Policy = "require-corp"

# Headers for /build path (bolt.new app)
[[headers]]
  for = "/build/*"
  [headers.values]
    Cross-Origin-Opener-Policy = "same-origin"
    Cross-Origin-Embedder-Policy = "require-corp"
    Cross-Origin-Resource-Policy = "cross-origin"

# Asset caching for bolt.new assets
[[headers]]
  for = "/build/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Override headers for the /subscribe route so that no strict isolation is enforced.
[[headers]]
  for = "/subscribe/*"
  [headers.values]
    Cross-Origin-Opener-Policy = "unsafe-none"
    Cross-Origin-Embedder-Policy = "unsafe-none"

# Redirect /subscribe to /subscribe/ to enforce a trailing slash.
[[redirects]]
  from = "/subscribe"
  to = "/subscribe/"
  status = 301
  force = true

# Rewrites for bolt.new SPA routing at /build
[[redirects]]
  from = "/build/*"
  to = "/build/index.html"
  status = 200
